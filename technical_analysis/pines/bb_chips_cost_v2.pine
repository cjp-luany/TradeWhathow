//@version=6
indicator(
     shorttitle="BB Chips ATR",
     title="Bollinger Bands + Chips Avg Cost 50 + ATR Stop Points",
     overlay=true
)

//========================
// Bollinger Bands
//========================
bb_length = input.int(26, minval=1, title="BB Length")
bb_maType = input.string("EMA", "Basis MA Type", options=["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
bb_src    = input.source(close, title="BB Source")
bb_mult   = input.float(2.0, minval=0.001, maxval=50, title="BB StdDev")
bb_offset = input.int(0, "BB Offset", minval=-500, maxval=500, display=display.data_window)

ma(source, length, _type) =>
    switch _type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

bb_basis = ma(bb_src, bb_length, bb_maType)
bb_dev   = bb_mult * ta.stdev(bb_src, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

bb_basisColor = close >= bb_basis ? color.lime : color.red
plot(bb_basis, "BB Basis", color=bb_basisColor, linewidth=3, offset=bb_offset)

bb_p1 = plot(bb_upper, "BB Upper", color=#F23645, offset=bb_offset)
bb_p2 = plot(bb_lower, "BB Lower", color=#089981, offset=bb_offset)
fill(bb_p1, bb_p2, title="BB Background", color=color.rgb(33, 150, 243, 95))

//========================
// Chips Avg Cost 50
//========================
chips_len        = input.int(50, "Avg Chips Len", minval=5, maxval=500)
chips_smooth_len = input.int(3, "Smooth Len", options=[1,2,3,4,5])
chips_line_col   = input.color(color.new(color.purple, 70), "Chips Line Color")
chips_line_w     = input.int(2, "Chips Line Width", minval=1, maxval=5)

chipsline(_len) =>
    w     = math.pow(hl2 - close, 2) * volume
    denom = math.sum(w, _len)
    numer = math.sum(w * close, _len)
    denom == 0 ? na : numer / denom

avg_cost_50 = ta.ema(chipsline(chips_len), chips_smooth_len)
plot(avg_cost_50, title="Avg Chips Cost (50)", color=chips_line_col, linewidth=chips_line_w)

//========================
// ATR Stop Loss Finder (points version)
//========================
atr_length    = input.int(14, minval=1, title="ATR Length")
atr_smoothing = input.string("RMA", title="ATR Smoothing", options=["RMA", "SMA", "EMA", "WMA"])
atr_mult      = input.float(1.5, "ATR Multiplier")

atr_show = input.bool(true, "Show ATR Stop Points")

// —— 颜色直接在脚本内定义（不接入 color cfg）——
atr_high_col = color.new(color.fuchsia, 70)  // 上止：洋红
atr_low_col  = color.new(color.green,   70)  // 下止：绿色

atr_ma(src, len) =>
    atr_smoothing == "RMA" ? ta.rma(src, len) :atr_smoothing == "SMA" ? ta.sma(src, len) : atr_smoothing == "EMA" ? ta.ema(src, len) :ta.wma(src, len)

// === 原 v4 ATR 逻辑（完全不改变） ===
atr_val = atr_ma(ta.tr(true), atr_length)
a  = atr_val * atr_mult
x  = high + a
x2 = low  - a

plot(atr_show ? x  : na,
     title="ATR Short Stop",
     style=plot.style_circles,
     linewidth=2,
     color=atr_high_col)

plot(atr_show ? x2 : na,
     title="ATR Long Stop",
     style=plot.style_circles,
     linewidth=2,
     color=atr_low_col)

//========================
// ATR Info Table
//========================
var Table = table.new(position.bottom_center, 3, 1, border_width=3)

f_fillCell(_table, _column, _row, _value, _label) =>
    table.cell(_table, _column, _row, _label + str.tostring(_value, "#.#"), text_color=color.blue)
    table.cell_set_text_color(_table, 1, 0, color.fuchsia) // H: 上止
    table.cell_set_text_color(_table, 2, 0, color.green)   // L: 下止

if barstate.islast
    f_fillCell(Table, 0, 0, a,  "ATR: ")
    f_fillCell(Table, 1, 0, x,  "H: ")
    f_fillCell(Table, 2, 0, x2, "L: ")
